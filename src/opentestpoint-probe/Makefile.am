EXTRA_DIST= \
 setup.py.in \
 otestpoint \
 meta \
 emm-gen


BUILT_SOURCES = \
 setup.py \
 otestpoint/emane_spectrum_tools/monitor.proto \
 otestpoint/emane_spectrum_tools/monitor_pb2.py \
 otestpoint/emane_spectrum_tools/probe-emane-spectrum-tools-monitor.xsd

all-local:
	$(PYTHON) setup.py build

clean-local: setup.py
	$(PYTHON) setup.py clean
	-rm -rf build
	-rm -rf dist
	-rm -f $(BUILT_SOURCES)
	-find . -name "*.pyc" -delete
	-find . -name "__pycache__" -delete
	-rm -rf otestpoint_emane_spectrum_tools.egg-info
	-rm -f .installedfiles

dist-hook:
	rm -f $(distdir)/otestpoint/emane_spectrum_tools/probe-emane-sprectrum-tools-monitor.xsd
	rm -f $(distdir)/otestpoint/emane_spectrum_tools/monitor.proto
	rm -f $(distdir)/otestpoint/emane_spectrum_tools/monitor_pb2.py

DISTCLEANFILES=setup.py

sdist:
	$(PYTHON) setup.py sdist

edit = sed                              \
        -e 's|@VERSION[@]|$(VERSION)|g' \
        -e 's|@PYTHON[@]|$(PYTHON)|g'

setup.py: setup.py.in
	if test -f $@; then chmod u+w $@; fi
	$(edit) $< > $@
	chmod g-w,u-w $@

install-exec-hook: $(BUILT_SOURCES)
	$(PYTHON) setup.py install \
        -O1 \
        --single-version-externally-managed \
        --record .installedfiles \
        --prefix=$(prefix) \
        --exec-prefix=$(exec_prefix) \
        $(if $(DESTDIR),--root=$(DESTDIR)) \
        $(if $(subst false,,$(HAVE_DEB)),--install-layout=deb)

uninstall-hook:
	if test -f .installedfiles; then xargs -a .installedfiles rm -f; fi

otestpoint/emane_spectrum_tools/monitor.proto otestpoint/emane_spectrum_tools/probe-emane-spectrum-tools-monitor.xsd: meta/spectrum-monitor.xml
	$(PYTHON) ./emm-gen -o Monitor -p otestpoint/emane_spectrum_tools $<

otestpoint/emane_spectrum_tools/monitor_pb2.py: otestpoint/emane_spectrum_tools/monitor.proto
	protoc -I. -I=otestpoint/emane_spectrum_tools -I=$(libotestpoint_PROTODIR) --python_out=. $<
	sed -i -e 's/import measurementtable_pb2/from otestpoint.interface import measurementtable_pb2/' $@

